<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Debby Booster Sites</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<header class="bg-white shadow">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-extrabold text-blue-600 tracking-wide">
      Debby<span class="text-gray-800">Booster</span>
    </h1>
    <button onclick="logout()" class="text-gray-600 hover:text-red-600 font-medium">Logout</button>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-8 grid grid-cols-1 md:grid-cols-3 gap-6">

  <!-- LEFT -->
  <div class="md:col-span-1 space-y-6">

    <!-- WALLET -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Wallet</h2>
      <p class="text-3xl font-extrabold text-blue-600 mb-4">
        $<span id="balance">0</span>
      </p>

      <input id="depositAmount" type="number" placeholder="Enter amount"
             class="w-full mb-3 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">

      <button onclick="createDeposit()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
        Deposit
      </button>
    </div>

    <!-- REFERRAL -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Referral Link</h2>
      <p class="text-sm text-gray-500 mb-2">Invite friends and earn commissions</p>
      <input id="referralLink" readonly class="w-full px-3 py-2 border rounded bg-gray-50 text-sm"/>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="md:col-span-2 space-y-6">

    <!-- PLACE ORDER -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Place Order</h2>

      <input placeholder="Service ID" class="w-full mb-3 px-4 py-2 border rounded-lg"/>
      <input placeholder="Link" class="w-full mb-3 px-4 py-2 border rounded-lg"/>
      <input placeholder="Quantity" type="number" class="w-full mb-3 px-4 py-2 border rounded-lg"/>

      <button class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
        Submit Order
      </button>
    </div>

    <!-- ORDERS TABLE -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">My Orders</h2>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="p-2 text-left">Service</th>
              <th class="p-2 text-left">Qty</th>
              <th class="p-2 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="ordersTable" class="divide-y">
            <tr>
              <td class="p-2">Instagram Likes</td>
              <td class="p-2">1000</td>
              <td class="p-2 text-blue-600 font-semibold">Pending</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

</main>

<footer class="text-center py-4 text-gray-400 text-sm">
  Â© 2026 Debby Booster Sites
</footer>

<script>
  const SUPABASE_URL = "https://sjyctlwlbriisblcksfd.supabase.co"
  const SUPABASE_ANON_KEY ="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqeWN0bHdsYnJpaXNibGNrc2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTY5MDksImV4cCI6MjA4NzM3MjkwOX0.pA9q6gW7cljyJECnAT11ZnwKCZ7owINc8MTlOnHyWKA"
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  let currentUser = null

  async function init() {
    const { data } = await supabaseClient.auth.getUser()
    if (!data.user) window.location.href = "auth.html"
    currentUser = data.user
    loadBalance()
    loadReferral()
  }

  async function loadBalance() {
    const { data, error } = await supabaseClient
      .from("users")
      .select("balance")
      .eq("id", currentUser.id)
      .single()

    if (error || !data) {
      console.error("Error loading balance:", error)
      document.getElementById("balance").innerText = "0"
      return
    }
    document.getElementById("balance").innerText = data.balance
  }

  async function createDeposit() {
    const amount = Number(document.getElementById("depositAmount").value)
    if (amount <= 0) return alert("Enter a valid amount")

    const { data: deposit, error } = await supabaseClient
      .from("deposits")
      .insert({ user_id: currentUser.id, amount, status: "pending" })
      .select()
      .single()

    if (error) return alert(error.message)

    // Call Netlify function to initialize Kora Pay
    const response = await fetch("/.netlify/functions/init-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: currentUser.id,
        amount,
        deposit_id: deposit.id,
        email: currentUser.email
      })
    })
    const result = await response.json()
    if (!result.checkout_url) return alert("Payment initialization failed")
    window.location.href = result.checkout_url
  }

  async function loadReferral() {
    const code = currentUser.id.substring(0, 8)
    document.getElementById("referralLink").value = `${window.location.origin}/auth.html?ref=${code}`
  }

  async function logout() {
    await supabaseClient.auth.signOut()
    window.location.href = "auth.html"
  }

  init()
</script>

</body>
</html>